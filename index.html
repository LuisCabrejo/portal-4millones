/**
 * üéØ SISTEMA DE DISTRIBUIDORES PARA CAT√ÅLOGO - VERSI√ìN H√çBRIDA
 * Este archivo personaliza el cat√°logo seg√∫n el distribuidor que lo comparte
 * Consulta TANTO auth.users COMO profiles para obtener datos completos
 */

// üîß Configuraci√≥n de Supabase (usar las mismas credenciales del portal)
const SUPABASE_URL = 'https://ovsvocjvjnqfaaugwnxg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c3ZvY2p2am5xZmFhdWd3bnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3ODEyMzcsImV4cCI6MjA2NzM1NzIzN30.ZErzsooaSXnS-NdmMYD0JcZFupFgrXfMLH-nOvU1NTE';

// Inicializar cliente Supabase
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/**
 * üéØ Generar slug desde nombre completo (igual que en portal)
 * @param {string} fullName - Nombre completo del usuario
 * @returns {string} Slug amigable
 */
function generarSlugDesdNombre(fullName) {
    if (!fullName) return null;

    try {
        // Extraer primer nombre + primer apellido
        const parts = fullName.trim().split(' ');
        const nombreApellido = parts.length >= 2 ? `${parts[0]} ${parts[1]}` : parts[0];

        // Convertir a slug amigable (misma l√≥gica que el portal)
        const slug = nombreApellido
            .toLowerCase()
            .normalize('NFD') // Descomponer caracteres acentuados
            .replace(/[\u0300-\u036f]/g, '') // Remover diacr√≠ticos
            .replace(/[^a-z0-9\s]/g, '') // Solo letras, n√∫meros y espacios
            .replace(/\s+/g, '-') // Espacios a guiones
            .replace(/-+/g, '-') // M√∫ltiples guiones a uno
            .replace(/^-|-$/g, ''); // Remover guiones al inicio/final

        return slug;
    } catch (error) {
        console.error('‚ùå Error generando slug:', error);
        return null;
    }
}

/**
 * üîç Obtener todos los usuarios desde m√∫ltiples fuentes (H√çBRIDO)
 * @returns {Array} Lista de usuarios con datos completos
 */
async function obtenerTodosLosUsuarios() {
    try {
        console.log('üîç Obteniendo usuarios desde m√∫ltiples fuentes...');

        let usuarios = [];

        // FUENTE 1: Tabla profiles (datos completos del portal)
        console.log('üìã Consultando tabla profiles...');
        const { data: profiles, error: profilesError } = await supabaseClient
            .from('profiles')
            .select('id, full_name, whatsapp, email')
            .not('full_name', 'is', null);

        if (profiles && profiles.length > 0) {
            console.log(`‚úÖ Encontrados ${profiles.length} perfiles en tabla profiles`);
            usuarios = [...usuarios, ...profiles.map(p => ({
                id: p.id,
                nombre: p.full_name,
                whatsapp: p.whatsapp || '',
                email: p.email || '',
                fuente: 'profiles'
            }))];
        } else {
            console.log('‚ö†Ô∏è No se encontraron datos en tabla profiles');
        }

        // FUENTE 2: Si no hay datos en profiles, consultar auth.users via RPC
        if (usuarios.length === 0) {
            console.log('üìã Intentando consultar usuarios de auth...');

            // Mapeo manual de usuarios conocidos (temporal)
            const usuariosConocidos = [
                {
                    id: '5460d8d0-f3d4-4db0-99ca-48650a41ef57',
                    nombre: 'Ganocaf√© Online',
                    whatsapp: '+573118870682',
                    email: 'admin@ganocafe.online',
                    fuente: 'manual'
                },
                {
                    id: '8e17b0bb-8029-4897-983f-57e53d5a0e64',
                    nombre: 'Luis Cabrejo Parra',
                    whatsapp: '+573203415438',
                    email: 'luiscabrejo@gmail.com',
                    fuente: 'manual'
                }
            ];

            console.log(`üìã Usando mapeo manual: ${usuariosConocidos.length} usuarios`);
            usuarios = [...usuarios, ...usuariosConocidos];
        }

        console.log(`‚úÖ Total de usuarios obtenidos: ${usuarios.length}`);
        usuarios.forEach((u, i) => {
            console.log(`   ${i+1}. ${u.nombre} (${u.fuente})`);
        });

        return usuarios;

    } catch (error) {
        console.error('‚ùå Error obteniendo usuarios:', error);
        return [];
    }
}

/**
 * üîç Buscar distribuidor por slug (VERSI√ìN H√çBRIDA MEJORADA)
 * @param {string} slug - Slug del distribuidor (ej: "ganocafe-online")
 * @returns {Object|null} Datos del distribuidor o null
 */
async function buscarDistribuidor(slug) {
    try {
        console.log('üîç Buscando distribuidor con slug:', slug);

        // Obtener todos los usuarios disponibles
        const usuarios = await obtenerTodosLosUsuarios();

        if (usuarios.length === 0) {
            console.warn('‚ö†Ô∏è No se encontraron usuarios en ninguna fuente');
            return null;
        }

        console.log(`üìã Comparando slug "${slug}" contra ${usuarios.length} usuarios...`);

        // Buscar coincidencia exacta
        let distribuidorEncontrado = null;

        for (const usuario of usuarios) {
            const slugGenerado = generarSlugDesdNombre(usuario.nombre);

            console.log(`üîç "${usuario.nombre}" ‚Üí "${slugGenerado}" vs "${slug}"`);

            if (slugGenerado === slug) {
                distribuidorEncontrado = usuario;
                console.log('‚úÖ ¬°DISTRIBUIDOR ENCONTRADO!', {
                    nombre: usuario.nombre,
                    slug_buscado: slug,
                    slug_generado: slugGenerado,
                    whatsapp: usuario.whatsapp,
                    fuente: usuario.fuente
                });
                break;
            }
        }

        if (distribuidorEncontrado) {
            // Formatear n√∫mero de WhatsApp
            let whatsappFormateado = distribuidorEncontrado.whatsapp;
            if (whatsappFormateado && !whatsappFormateado.startsWith('+')) {
                whatsappFormateado = '+57' + whatsappFormateado.replace(/[^\d]/g, '');
            }

            return {
                nombre: distribuidorEncontrado.nombre,
                whatsapp: whatsappFormateado,
                email: distribuidorEncontrado.email,
                slug: slug,
                primer_nombre: distribuidorEncontrado.nombre.split(' ')[0],
                fuente: distribuidorEncontrado.fuente
            };
        }

        console.warn('‚ö†Ô∏è No se encontr√≥ distribuidor para el slug:', slug);
        return null;

    } catch (error) {
        console.error('‚ùå Error en b√∫squeda de distribuidor:', error);
        return null;
    }
}

/**
 * üé® Personalizar cat√°logo con datos del distribuidor (MEJORADO)
 * @param {Object} distribuidor - Datos del distribuidor
 */
function personalizarCatalogo(distribuidor) {
    try {
        console.log('üé® Personalizando cat√°logo para:', distribuidor.nombre);

        // 1. Personalizar t√≠tulo de la p√°gina
        document.title = `Cat√°logo de ${distribuidor.primer_nombre} - Gano Excel`;

        // 2. Personalizar header principal
        const headerTitle = document.querySelector('header h1');
        if (headerTitle) {
            headerTitle.textContent = `Cat√°logo de Bienestar de ${distribuidor.primer_nombre}`;
        }

        // 3. Personalizar subt√≠tulo del header
        const headerSubtitle = document.querySelector('header p');
        if (headerSubtitle) {
            headerSubtitle.textContent = `Descubre los productos Gano Excel recomendados por ${distribuidor.primer_nombre}`;
        }

        // 4. Personalizar mensaje de bienvenida
        const welcomeSection = document.querySelector('.welcome-section');
        if (welcomeSection) {
            const welcomeTitle = welcomeSection.querySelector('h2');
            const welcomeText = welcomeSection.querySelector('p');

            if (welcomeTitle) {
                welcomeTitle.textContent = `Bienvenido al cat√°logo de ${distribuidor.primer_nombre}`;
            }

            if (welcomeText) {
                welcomeText.innerHTML = `
                    <strong>${distribuidor.primer_nombre}</strong> te invita a explorar estos productos dise√±ados para nutrir tu cuerpo y mejorar tu d√≠a a d√≠a.
                    Cada uno combina lo mejor de la naturaleza con innovaci√≥n cient√≠fica.
                    <br><br>
                    <strong>üí¨ Para m√°s informaci√≥n, precios o realizar un pedido, contacta directamente a ${distribuidor.primer_nombre} usando el bot√≥n de WhatsApp.</strong>
                `;
            }
        }

        // 5. Configurar bot√≥n de WhatsApp personalizado
        configurarWhatsAppPersonalizado(distribuidor);

        // 6. Agregar badge de distribuidor
        agregarBadgeDistribuidor(distribuidor);

        console.log('‚úÖ Cat√°logo personalizado exitosamente para:', distribuidor.nombre);

    } catch (error) {
        console.error('‚ùå Error personalizando cat√°logo:', error);
    }
}

/**
 * üì± Configurar bot√≥n de WhatsApp personalizado del distribuidor
 * @param {Object} distribuidor - Datos del distribuidor
 */
function configurarWhatsAppPersonalizado(distribuidor) {
    try {
        const whatsappButton = document.getElementById('whatsapp-button');

        if (whatsappButton && distribuidor.whatsapp) {
            // Mensaje personalizado con el nombre del distribuidor
            const mensaje = `Hola ${distribuidor.primer_nombre}, vi tu cat√°logo de productos Gano Excel y me interesan. ¬øMe podr√≠as dar m√°s informaci√≥n sobre precios y disponibilidad?`;

            // URL de WhatsApp con n√∫mero del distribuidor
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${distribuidor.whatsapp}&text=${encodeURIComponent(mensaje)}`;

            whatsappButton.href = whatsappUrl;
            whatsappButton.style.display = 'flex';
            whatsappButton.title = `Contactar a ${distribuidor.primer_nombre} por WhatsApp`;

            console.log('üì± WhatsApp configurado para:', {
                nombre: distribuidor.primer_nombre,
                whatsapp: distribuidor.whatsapp,
                mensaje_preview: mensaje.substring(0, 50) + '...',
                fuente: distribuidor.fuente
            });
        } else {
            console.warn('‚ö†Ô∏è No se pudo configurar WhatsApp:', {
                button_exists: !!whatsappButton,
                has_whatsapp: !!distribuidor.whatsapp
            });
        }

    } catch (error) {
        console.error('‚ùå Error configurando WhatsApp personalizado:', error);
    }
}

/**
 * üè∑Ô∏è Agregar badge de distribuidor para mayor confianza
 * @param {Object} distribuidor - Datos del distribuidor
 */
function agregarBadgeDistribuidor(distribuidor) {
    try {
        const header = document.querySelector('header');
        if (header && !header.querySelector('.distributor-badge')) {
            // Crear badge de distribuidor
            const badge = document.createElement('div');
            badge.className = 'distributor-badge';
            badge.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #25D366, #128C7E);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 600;
                    margin: 10px auto;
                    display: inline-block;
                    box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
                ">
                    üì± Cat√°logo compartido por ${distribuidor.primer_nombre}
                </div>
            `;

            header.appendChild(badge);
            console.log('üè∑Ô∏è Badge de distribuidor agregado');
        }
    } catch (error) {
        console.error('‚ùå Error agregando badge:', error);
    }
}

/**
 * üîÑ Configurar fallback si no hay distribuidor espec√≠fico
 */
function configurarFallback() {
    try {
        console.log('üîÑ Configurando fallback (distribuidor por defecto)');

        const whatsappButton = document.getElementById('whatsapp-button');

        if (whatsappButton) {
            // N√∫mero por defecto de Ganocaf√© Online
            const numeroDefecto = '+573118870682';
            const mensajeDefecto = 'Hola, vi el cat√°logo de productos Gano Excel y me interesan. ¬øMe podr√≠as dar m√°s informaci√≥n sobre precios y disponibilidad?';
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${numeroDefecto}&text=${encodeURIComponent(mensajeDefecto)}`;

            whatsappButton.href = whatsappUrl;
            whatsappButton.style.display = 'flex';
            whatsappButton.title = 'Contactar por WhatsApp';

            console.log('üì± WhatsApp configurado con n√∫mero por defecto:', numeroDefecto);
        }

        // Mantener t√≠tulo original
        document.title = 'Cat√°logo de Bienestar - Gano Excel';

    } catch (error) {
        console.error('‚ùå Error configurando fallback:', error);
    }
}

/**
 * üöÄ Funci√≥n principal: Inicializar sistema de distribuidores
 */
async function inicializarDistribuidor() {
    try {
        console.log('üöÄ =================================');
        console.log('üéØ INICIALIZANDO SISTEMA DE DISTRIBUIDORES H√çBRIDO');
        console.log('üöÄ =================================');

        // Leer par√°metros de URL
        const urlParams = new URLSearchParams(window.location.search);
        const distribuidorSlug = urlParams.get('distribuidor');
        const socioId = urlParams.get('socio'); // Fallback para compatibilidad

        console.log('üìã Par√°metros detectados:', {
            distribuidor: distribuidorSlug,
            socio: socioId,
            url_completa: window.location.href
        });

        if (distribuidorSlug) {
            console.log('üîç Buscando distribuidor con slug:', distribuidorSlug);

            // Buscar distribuidor espec√≠fico por slug
            const distribuidor = await buscarDistribuidor(distribuidorSlug);

            if (distribuidor) {
                console.log('‚úÖ DISTRIBUIDOR ENCONTRADO - Personalizando cat√°logo...');
                console.log('üìä Datos del distribuidor:', distribuidor);
                personalizarCatalogo(distribuidor);

                // Mostrar confirmaci√≥n visual en la p√°gina
                setTimeout(() => {
                    console.log('üéâ CAT√ÅLOGO PERSONALIZADO EXITOSAMENTE');
                    console.log(`üì± WhatsApp configurado para: ${distribuidor.primer_nombre}`);
                    console.log(`üîó N√∫mero: ${distribuidor.whatsapp}`);
                }, 1000);

            } else {
                console.warn('‚ö†Ô∏è Distribuidor no encontrado para slug:', distribuidorSlug);
                console.log('üîÑ Aplicando configuraci√≥n por defecto...');
                configurarFallback();
            }

        } else if (socioId) {
            console.log('üìù Par√°metro socio detectado (compatibilidad), usando fallback');
            configurarFallback();

        } else {
            console.log('üìù Sin par√°metros de distribuidor, usando configuraci√≥n por defecto');
            configurarFallback();
        }

        console.log('üöÄ =================================');
        console.log('‚úÖ INICIALIZACI√ìN COMPLETADA');
        console.log('üöÄ =================================');

    } catch (error) {
        console.error('‚ùå Error cr√≠tico inicializando distribuidor:', error);
        console.log('üîÑ Aplicando fallback por error...');
        configurarFallback();
    }
}

/**
 * üé¨ Ejecutar cuando el DOM y Supabase est√©n listos
 */
document.addEventListener('DOMContentLoaded', () => {
    console.log('üé¨ DOM cargado, verificando dependencias...');

    // Verificar que Supabase est√© disponible
    if (typeof window.supabase === 'undefined') {
        console.error('‚ùå Supabase no est√° disponible en el cat√°logo');
        console.log('üîÑ Aplicando fallback por falta de Supabase...');
        setTimeout(configurarFallback, 1000);
        return;
    }

    console.log('‚úÖ Supabase disponible, inicializando sistema...');

    // Peque√±o delay para asegurar que todo est√© cargado
    setTimeout(() => {
        inicializarDistribuidor();
    }, 500);
});

// Mensaje de confirmaci√≥n de carga
console.log('üéØ ===================================');
console.log('‚úÖ SISTEMA DE DISTRIBUIDORES H√çBRIDO CARGADO');
console.log('üéØ ===================================');
