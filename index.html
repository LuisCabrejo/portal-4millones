<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizaci√≥n 4 Millones - Centro de Socios</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- CSS modular -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components.css">
</head>
<!-- üì± FIX: Marcado como p√°gina de portal (no auth) -->
<body data-page="portal">
    <!-- üé® HEADER MOBILE PREMIUM REDISE√ëADO -->
    <header class="mobile-header">
        <div class="mobile-header-content">
            <!-- üé® LOGOTIPO PREMIUM -->
            <div class="mobile-logo">
                <!-- Opci√≥n 1: Con imagen (cuando tengas el logo) -->
                <!-- <img src="assets/images/logo-4millones.png" alt="4 Millones" class="mobile-logo-img"> -->

                <!-- Opci√≥n 2: Texto premium (temporal) -->
                <div class="mobile-logo-text">4 Millones</div>
            </div>

            <!-- üé® USER AREA PREMIUM -->
            <div class="mobile-user-area" id="mobile-user-area">
                <div class="mobile-user-avatar" id="mobile-user-avatar">
                    U
                </div>
                <div class="mobile-user-info-inline">
                    <div class="mobile-user-name-inline" id="mobile-user-name-inline">
                        Usuario
                    </div>
                    <div class="mobile-user-role">
                        Socio Estrat√©gico
                    </div>
                </div>
                <div class="mobile-dropdown-arrow">‚ñº</div>

                <!-- üé® DROPDOWN PREMIUM -->
                <div class="mobile-user-dropdown" id="mobile-user-dropdown">
                    <div class="mobile-user-info-dropdown">
                        <div class="mobile-user-avatar-large" id="mobile-user-avatar-large">
                            U
                        </div>
                        <div class="mobile-user-name-dropdown" id="mobile-user-name-dropdown">
                            Usuario
                        </div>
                        <div class="mobile-user-email" id="mobile-user-email-dropdown">
                            email@ejemplo.com
                        </div>
                    </div>
                    <div class="mobile-menu-item" id="mobile-menu-profile">
                        <span class="mobile-menu-icon">‚öôÔ∏è</span>
                        Mi Perfil
                    </div>
                    <div class="mobile-menu-item logout" id="mobile-menu-logout">
                        <span class="mobile-menu-icon">üö™</span>
                        Cerrar Sesi√≥n
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Loading state -->
    <div id="loading" class="loading-container">
        <div class="loading-spinner large"></div>
        <p>Verificando autenticaci√≥n...</p>
    </div>

    <!-- Main content (hidden initially) -->
    <div id="main-content" style="display: none;">
        <div class="particles">
            <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
            <div class="particle" style="left: 20%; animation-delay: 1s;"></div>
            <div class="particle" style="left: 30%; animation-delay: 2s;"></div>
            <div class="particle" style="left: 40%; animation-delay: 3s;"></div>
            <div class="particle" style="left: 50%; animation-delay: 4s;"></div>
            <div class="particle" style="left: 60%; animation-delay: 5s;"></div>
            <div class="particle" style="left: 70%; animation-delay: 6s;"></div>
            <div class="particle" style="left: 80%; animation-delay: 7s;"></div>
            <div class="particle" style="left: 90%; animation-delay: 0.5s;"></div>
        </div>

        <div class="main-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="logo-container">
                        <h2>Proyecto 4 Millones</h2>
                        <p>Centro de Socios Estrat√©gicos</p>
                    </div>
                </div>

                <!-- User info section - Solo Desktop -->
                <div class="user-info" id="user-info">
                    <div class="user-name" id="user-name">Cargando...</div>
                    <div class="user-email" id="user-email">Cargando...</div>
                    <button class="logout-btn" id="logout-btn">Cerrar Sesi√≥n</button>
                </div>

                <nav class="sidebar-nav">
                    <a href="#" class="active">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                    <a href="pages/profile.html">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        <span>Mi Perfil</span>
                    </a>
                </nav>

                <div class="sidebar-footer">
                    &copy; 2025 - 4millones.com
                </div>
            </aside>

            <main class="content-area">
                <header class="content-header">
                    <h1>Organizaci√≥n 4 Millones</h1>
                    <p id="main-description">Tu centro de herramientas premium para construir tu propio activo empresarial con el respaldo de una organizaci√≥n l√≠der.</p>
                    <div class="welcome-message" id="welcome-message">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" style="width: 16px; height: 16px; margin-right: 8px;">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                        <span id="welcome-text">Herramientas de √öltima Generaci√≥n</span>
                    </div>
                </header>

                <!-- Mensajes del sistema -->
                <div id="message" style="display: none; margin-bottom: 20px;"></div>

                <div class="tools-grid">
                    <!-- üö® FIX: Card Cat√°logo con WhatsApp API corregida -->
                    <div class="tool-card">
                        <div class="tool-card-image" style="background-image: url('https://4millones.com/wp-content/uploads/2025/07/gano-cafe-clasico-catalogo-min.png');">
                            <div class="status-badge available">Disponible</div>
                        </div>
                        <div class="tool-card-content">
                            <h3>Cat√°logo Interactivo</h3>
                            <p>Presenta y comparte f√°cilmente todo el portafolio de productos con tus clientes para cerrar m√°s ventas. Herramienta optimizada para conversiones.</p>
                            <!-- ‚úÖ WhatsApp funcionando con api.whatsapp.com -->
                            <button class="btn" id="catalog-share-btn" data-tool="catalog" data-action="share" data-url="https://catalogo.4millones.com/" style="margin-bottom: 10px; background: #25D366; border: none;">
                                üì± Compartir v√≠a WhatsApp
                            </button>
                            <button class="btn" id="catalog-open-btn" data-tool="catalog" data-action="open" data-url="https://catalogo.4millones.com/">
                                üîó Abrir Cat√°logo
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- üö® FIX: Card Modelo de Negocio con WhatsApp API corregida -->
                    <div class="tool-card">
                        <div class="tool-card-image" style="background-image: url('https://images.unsplash.com/photo-1556740738-b6a63e27c4df?q=80&w=1470&auto=format&fit=crop');">
                            <div class="status-badge available">Disponible</div>
                        </div>
                        <div class="tool-card-content">
                            <h3>Modelo de Negocio</h3>
                            <p>La herramienta clave para presentar el modelo de negocio. Expande tu organizaci√≥n invitando nuevos socios y construye un activo empresarial que genere ingresos residuales.</p>
                            <!-- ‚úÖ WhatsApp funcionando con api.whatsapp.com -->
                            <button class="btn" id="business-share-btn" data-tool="business" data-action="share" data-url="https://oportunidad.4millones.com/" style="margin-bottom: 10px; background: #25D366; border: none;">
                                üì± Compartir v√≠a WhatsApp
                            </button>
                            <button class="btn" id="business-open-btn" data-tool="business" data-action="open" data-url="https://oportunidad.4millones.com/">
                                üîó Abrir Presentaci√≥n
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="tool-card placeholder-card">
                        <div class="tool-card-content">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                                <path d="M9 7.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1zm-3 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1z"/>
                            </svg>
                            <h3>Agenda de Capacitaci√≥n</h3>
                            <p>Con√©ctate a los pr√≥ximos talleres y capacitaciones de producto y negocio para acelerar tu crecimiento profesional.</p>
                            <span class="coming-soon">Pr√≥ximamente</span>
                        </div>
                    </div>

                    <div class="tool-card placeholder-card">
                        <div class="tool-card-content">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            <h3>Recursos de Marketing</h3>
                            <p>Descarga im√°genes, fichas y material de apoyo listos para usar en tus redes sociales y potenciar tus ventas digitales.</p>
                            <span class="coming-soon">Pr√≥ximamente</span>
                        </div>
                    </div>

                    <div class="tool-card placeholder-card">
                        <div class="tool-card-content">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                            <h3>Centro de Soporte</h3>
                            <p>Accede a tutoriales, gu√≠as paso a paso y soporte t√©cnico personalizado para maximizar el uso de todas las herramientas.</p>
                            <span class="coming-soon">Pr√≥ximamente</span>
                        </div>
                    </div>

                    <div class="tool-card placeholder-card">
                        <div class="tool-card-content">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.708 2.825L15 11.105V5.383zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741zM1 11.105l4.708-2.897L1 5.383v5.722z"/>
                            </svg>
                            <h3>Email Marketing</h3>
                            <p>Herramientas de email marketing automatizado para nutrir leads y convertir prospectos en clientes activos.</p>
                            <span class="coming-soon">Pr√≥ximamente</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Error state -->
    <div id="error-content" class="error-container" style="display: none;">
        <h2>Error de Autenticaci√≥n</h2>
        <p>No se pudo cargar el sistema de autenticaci√≥n. Por favor, recarga la p√°gina.</p>
        <button onclick="window.location.reload()" class="btn">Recargar P√°gina</button>
    </div>

    <!-- Cargar Supabase desde CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Script con todas las correcciones -->
    <script type="module">
        // üö® FIX CR√çTICO: Imports corregidos - ELIMINADA importaci√≥n duplicada
        import {
            initializeSupabase,
            authGuard,
            getUserProfile,
            logoutUser
        } from './assets/js/auth.js';

        import {
            showLoading,
            showMainContent,
            showError,
            formatUserName,
            showMessage,
            clearMessage,
            shareToolWithWhatsApp,      // ‚úÖ WhatsApp funcionando
            generatePersonalizedUrl,    // üéØ Nueva funci√≥n para URLs amigables
            getPersonalizedLinks,       // ‚úÖ √öNICA importaci√≥n v√°lida desde utils.js
            logout,
            TOOL_CONFIG,
            initializeMobileHeaderControl  // üì± Control de header mobile
        } from './assets/js/utils.js';

        import { MESSAGES } from './assets/js/config.js';

        // Variables globales
        let currentUserProfile = null;
        let isLoading = false;

        console.log('üöÄ Iniciando carga del portal...');

        // üì± FIX: Inicializar control de header mobile
        initializeMobileHeaderControl();

        // Verificar Supabase
        if (typeof supabase === 'undefined') {
            console.error('‚ùå Supabase no disponible');
            showError(MESSAGES.authRequired);
        } else {
            // Inicializar aplicaci√≥n
            try {
                initializeSupabase();
                console.log('‚úÖ Supabase inicializado correctamente');

                // Funci√≥n para obtener iniciales
                const getInitials = (name) => {
                    if (!name) return 'U';
                    const parts = name.trim().split(' ');
                    if (parts.length >= 2) {
                        return (parts[0][0] + parts[1][0]).toUpperCase();
                    }
                    return parts[0][0].toUpperCase();
                };

                // Funci√≥n para obtener nombre para display (primer nombre + primer apellido)
                const getDisplayName = (fullName) => {
                    if (!fullName) return 'Usuario';
                    const parts = fullName.trim().split(' ');
                    if (parts.length >= 2) {
                        return `${parts[0]} ${parts[1]}`;
                    }
                    return parts[0];
                };

                // Funci√≥n principal
                const loadPortal = async () => {
                    try {
                        console.log('üîê Verificando autenticaci√≥n...');
                        const session = await authGuard(true);
                        if (!session) return;

                        console.log('üë§ Obteniendo perfil del usuario...');
                        const profile = await getUserProfile();
                        if (!profile) {
                            console.error('‚ùå No se pudo obtener el perfil');
                            showError('Error al cargar perfil');
                            return;
                        }

                        // üö® FIX CR√çTICO: Validar y guardar perfil COMPLETO globalmente
                        if (!profile.id) {
                            console.error('‚ùå Perfil sin ID v√°lido:', profile);
                            showError('Error: Perfil de usuario incompleto');
                            return;
                        }

                        currentUserProfile = profile;
                        console.log('‚úÖ Perfil COMPLETO cargado y validado:', {
                            id: profile.id,
                            email: profile.email,
                            full_name: profile.full_name,
                            whatsapp: profile.whatsapp,
                            todas_las_propiedades: Object.keys(profile)
                        });

                        console.log('üé® Personalizando interfaz del portal...');

                        // Formatear nombres
                        const fullName = formatUserName(profile.full_name) ||
                                       formatUserName(`${profile.first_name || ''} ${profile.last_name || ''}`.trim()) ||
                                       'Usuario';

                        const displayName = getDisplayName(fullName);
                        const initials = getInitials(fullName);
                        const firstName = fullName.split(' ')[0];

                        // Actualizar UI Desktop
                        document.getElementById('user-name').textContent = fullName;
                        document.getElementById('user-email').textContent = profile.email;

                        // üé® Actualizar UI Mobile Premium
                        document.getElementById('mobile-user-name-inline').textContent = displayName;
                        document.getElementById('mobile-user-name-dropdown').textContent = fullName;
                        document.getElementById('mobile-user-email-dropdown').textContent = profile.email;

                        // Actualizar avatares con iniciales
                        document.getElementById('mobile-user-avatar').textContent = initials;
                        document.getElementById('mobile-user-avatar-large').textContent = initials;

                        // Personalizar mensaje de bienvenida
                        document.getElementById('welcome-text').textContent = `Bienvenido, ${firstName}`;

                        // üö® FIX CR√çTICO: Probar las funciones con el perfil cargado
                        console.log('üß™ Probando generaci√≥n de URL personalizada...');
                        const testUrl = generatePersonalizedUrl('https://catalogo.4millones.com/', currentUserProfile);
                        console.log('üîó URL de prueba generada:', testUrl);

                        // Configurar event listeners
                        setupEventListeners();

                        console.log('‚úÖ Portal cargado exitosamente para:', fullName);
                        showMainContent();

                    } catch (error) {
                        console.error('‚ùå Error cr√≠tico al cargar portal:', error);
                        showError('Error al cargar portal: ' + error.message);
                    }
                };

                // üé® Event listeners premium con debugging
                const setupEventListeners = () => {
                    // Desktop logout button
                    const logoutBtn = document.getElementById('logout-btn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (confirm('¬øCerrar sesi√≥n?')) {
                                logout();
                            }
                        });
                    }

                    // üé® Mobile user area premium
                    const mobileUserArea = document.getElementById('mobile-user-area');
                    const mobileUserDropdown = document.getElementById('mobile-user-dropdown');
                    const mobileMenuLogout = document.getElementById('mobile-menu-logout');
                    const mobileMenuProfile = document.getElementById('mobile-menu-profile');

                    if (mobileUserArea && mobileUserDropdown) {
                        // Toggle dropdown premium
                        mobileUserArea.addEventListener('click', (e) => {
                            e.stopPropagation();
                            mobileUserArea.classList.toggle('active');
                            mobileUserDropdown.classList.toggle('show');
                        });

                        // Close dropdown cuando clic fuera
                        document.addEventListener('click', () => {
                            mobileUserArea.classList.remove('active');
                            mobileUserDropdown.classList.remove('show');
                        });

                        // Prevenir cierre cuando clic dentro
                        mobileUserDropdown.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                    }

                    // Mobile menu actions
                    if (mobileMenuLogout) {
                        mobileMenuLogout.addEventListener('click', (e) => {
                            e.preventDefault();
                            mobileUserArea.classList.remove('active');
                            mobileUserDropdown.classList.remove('show');
                            if (confirm('¬øCerrar sesi√≥n?')) {
                                logout();
                            }
                        });
                    }

                    if (mobileMenuProfile) {
                        mobileMenuProfile.addEventListener('click', (e) => {
                            e.preventDefault();
                            mobileUserArea.classList.remove('active');
                            mobileUserDropdown.classList.remove('show');
                            window.location.href = 'pages/profile.html';
                        });
                    }

                    // üö® FIX CR√çTICO: Event listener para botones de herramientas con debugging extensivo
                    document.addEventListener('click', async (event) => {
                        const target = event.target;

                        // Prevenir m√∫ltiples clics durante loading
                        if (isLoading) {
                            console.log('‚è≥ Acci√≥n en progreso, ignorando clic');
                            return;
                        }

                        // Verificar si es un bot√≥n de herramienta
                        if (target.dataset.action && target.dataset.tool) {
                            event.preventDefault();
                            console.log('üîß Bot√≥n de herramienta clickeado:', {
                                action: target.dataset.action,
                                tool: target.dataset.tool,
                                url: target.dataset.url
                            });

                            const action = target.dataset.action;
                            const toolType = target.dataset.tool;
                            const toolUrl = target.dataset.url;

                            // üö® FIX CR√çTICO: Validaci√≥n exhaustiva del perfil
                            if (!currentUserProfile) {
                                console.error('‚ùå currentUserProfile es null o undefined');
                                showMessage('‚ùå Error: Perfil de usuario no disponible. Recarga la p√°gina.', 'error');
                                return;
                            }

                            if (!currentUserProfile.id) {
                                console.error('‚ùå currentUserProfile.id no est√° disponible:', currentUserProfile);
                                showMessage('‚ùå Error: ID de usuario no disponible. Recarga la p√°gina.', 'error');
                                return;
                            }

                            console.log('‚úÖ Perfil validado, procediendo con la acci√≥n:', {
                                action: action,
                                userProfile: {
                                    id: currentUserProfile.id,
                                    full_name: currentUserProfile.full_name,
                                    whatsapp: currentUserProfile.whatsapp
                                }
                            });

                            isLoading = true;
                            const originalText = target.textContent;
                            target.disabled = true;

                            try {
                                if (action === 'share') {
                                    // ‚úÖ WhatsApp con debugging completo
                                    target.textContent = 'Generando enlace...';

                                    if (!toolUrl) {
                                        throw new Error('URL de herramienta no encontrada');
                                    }

                                    console.log(`üì± Iniciando compartir ${toolType} v√≠a WhatsApp...`);
                                    console.log('üìä Datos para WhatsApp:', {
                                        toolType: toolType,
                                        toolUrl: toolUrl,
                                        userProfile: {
                                            id: currentUserProfile.id,
                                            full_name: currentUserProfile.full_name,
                                            email: currentUserProfile.email
                                        }
                                    });

                                    // üö® FIX CR√çTICO: Llamar funci√≥n con debugging
                                    shareToolWithWhatsApp(toolType, currentUserProfile, toolUrl);
                                    console.log('‚úÖ Funci√≥n shareToolWithWhatsApp ejecutada');

                                } else if (action === 'open') {
                                    // üéØ Abrir herramienta con URL personalizada
                                    target.textContent = 'Abriendo...';

                                    if (!toolUrl) {
                                        throw new Error('URL de herramienta no encontrada');
                                    }

                                    console.log(`üîó Abriendo ${toolType}...`);
                                    console.log('üìä Datos para generar URL:', {
                                        toolUrl: toolUrl,
                                        userProfile: {
                                            id: currentUserProfile.id,
                                            full_name: currentUserProfile.full_name
                                        }
                                    });

                                    const personalizedUrl = generatePersonalizedUrl(toolUrl, currentUserProfile);
                                    console.log('üîó URL personalizada generada:', personalizedUrl);

                                    if (personalizedUrl && personalizedUrl !== '#') {
                                        window.open(personalizedUrl, '_blank');
                                        showMessage('‚úÖ Abriendo herramienta', 'success');
                                        console.log('‚úÖ Herramienta abierta exitosamente');
                                    } else {
                                        throw new Error('No se pudo generar URL personalizada');
                                    }
                                }

                            } catch (error) {
                                console.error(`‚ùå Error cr√≠tico en acci√≥n ${action}:`, error);
                                showMessage(`‚ùå Error al ${action === 'share' ? 'compartir' : 'abrir'} herramienta: ${error.message}`, 'error');
                            } finally {
                                setTimeout(() => {
                                    target.textContent = originalText;
                                    target.disabled = false;
                                    isLoading = false;
                                    console.log('üîÑ Estado de bot√≥n restaurado');
                                }, 2000);
                            }
                        }
                    });

                    console.log('‚úÖ Event listeners configurados correctamente');
                };

                // Inicializar aplicaci√≥n
                console.log('üöÄ Iniciando carga del portal...');
                loadPortal();

            } catch (error) {
                console.error('‚ùå Error cr√≠tico de inicializaci√≥n:', error);
                showError('Error al inicializar aplicaci√≥n: ' + error.message);
            }
        }

        // Manejo de errores de red
        window.addEventListener('online', () => {
            console.log('üåê Conexi√≥n a internet restaurada');
            showMessage('üåê Conexi√≥n restaurada', 'success', 3000);
        });

        window.addEventListener('offline', () => {
            console.log('üì° Conexi√≥n a internet perdida');
            showMessage('üì° Sin conexi√≥n a internet', 'error', 5000);
        });

        // Manejar orientaci√≥n en m√≥vil
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100);
        });

        console.log('‚úÖ Script principal cargado completamente');
    </script>
</body>
</html>
