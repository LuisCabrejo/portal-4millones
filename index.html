<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organización 4 Millones - Centro de Socios</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- CSS modular -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
    <!-- Loading state -->
    <div id="loading" class="loading-container">
        <div class="loading-spinner large"></div>
        <p>Verificando autenticación...</p>
    </div>

    <!-- Main content (hidden initially) -->
    <div id="main-content" style="display: none;">
        <div class="particles">
            <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
            <div class="particle" style="left: 20%; animation-delay: 1s;"></div>
            <div class="particle" style="left: 30%; animation-delay: 2s;"></div>
            <div class="particle" style="left: 40%; animation-delay: 3s;"></div>
            <div class="particle" style="left: 50%; animation-delay: 4s;"></div>
            <div class="particle" style="left: 60%; animation-delay: 5s;"></div>
            <div class="particle" style="left: 70%; animation-delay: 6s;"></div>
            <div class="particle" style="left: 80%; animation-delay: 7s;"></div>
            <div class="particle" style="left: 90%; animation-delay: 0.5s;"></div>
        </div>

        <div class="main-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="logo-container">
                        <h2>Proyecto 4 Millones</h2>
                        <p>Centro de Socios Estratégicos</p>
                    </div>
                </div>

                <!-- User info section -->
                <div class="user-info" id="user-info">
                    <div class="user-name" id="user-name">Cargando...</div>
                    <div class="user-email" id="user-email">Cargando...</div>
                    <button class="logout-btn" id="logout-btn">Cerrar Sesión</button>
                </div>

                <nav class="sidebar-nav">
                    <a href="#" class="active">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                    <a href="pages/profile.html">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        <span>Mi Perfil</span>
                    </a>
                </nav>

                <div class="sidebar-footer">
                    &copy; 2025 - 4millones.com
                </div>
            </aside>

            <main class="content-area">
                <header class="content-header">
                    <h1>Organización 4 Millones</h1>
                    <p id="main-description">Tu centro de herramientas premium para construir tu propio activo empresarial con el respaldo de una organización líder.</p>
                    <div class="welcome-message" id="welcome-message">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" style="width: 16px; height: 16px; margin-right: 8px;">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                        <span id="welcome-text">Herramientas de Última Generación</span>
                    </div>
                </header>

                <!-- Mensajes del sistema -->
                <div id="message" style="display: none; margin-bottom: 20px;"></div>

                <div class="tools-grid">
                    <!-- Card Catálogo - FIX CRÍTICO: WhatsApp Integration -->
                    <div class="tool-card">
                        <div class="tool-card-image" style="background-image: url('https://4millones.com/wp-content/uploads/2025/07/gano-cafe-clasico-catalogo-min.png');">
                            <div class="status-badge available">Disponible</div>
                        </div>
                        <div class="tool-card-content">
                            <h3>Catálogo Interactivo</h3>
                            <p>Presenta y comparte fácilmente todo el portafolio de productos con tus clientes para cerrar más ventas. Herramienta optimizada para conversiones.</p>
                            <!-- FIX CRÍTICO: Botones con funcionalidad WhatsApp -->
                            <button class="btn" id="catalog-share-btn" data-tool="catalog" data-action="share" style="margin-bottom: 10px; background: #25D366; border: none;">
                                📱 Compartir via WhatsApp
                            </button>
                            <button class="btn" id="catalog-open-btn" data-tool="catalog" data-action="open" data-url="https://catalogo.4millones.com/">
                                🔗 Abrir Catálogo
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Card Modelo de Negocio - FIX CRÍTICO: WhatsApp Integration -->
                    <div class="tool-card">
                        <div class="tool-card-image" style="background-image: url('https://images.unsplash.com/photo-1556740738-b6a63e27c4df?q=80&w=1470&auto=format&fit=crop');">
                            <div class="status-badge available">Disponible</div>
                        </div>
                        <div class="tool-card-content">
                            <h3>Modelo de Negocio</h3>
                            <p>La herramienta clave para presentar el modelo de negocio. Expande tu organización invitando nuevos socios y construye un activo empresarial que genere ingresos residuales.</p>
                            <!-- FIX CRÍTICO: Botones con funcionalidad WhatsApp -->
                            <button class="btn" id="business-share-btn" data-tool="business" data-action="share" style="margin-bottom: 10px; background: #25D366; border: none;">
                                📱 Compartir via WhatsApp
                            </button>
                            <button class="btn" id="business-open-btn" data-tool="business" data-action="open" data-url="https://oportunidad.4millones.com/">
                                🔗 Abrir Presentación
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="tool-card placeholder-card">
                        <div class="tool-card-content">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                                <path d="M9 7.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1zm-3 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1z"/>
                            </svg>
                            <h3>Agenda de Capacitación</h3>
                            <p>Conéctate a los próximos talleres y capacitaciones de producto y negocio para acelerar tu crecimiento profesional.</p>
                            <span class="coming-soon">Próximamente</span>
                        </div>
                    </div>

                    <div class="tool-card placeholder-card">
                        <div class="tool-card-content">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            <h3>Recursos de Marketing</h3>
                            <p>Descarga imágenes, fichas y material de apoyo listos para usar en tus redes sociales y potenciar tus ventas digitales.</p>
                            <span class="coming-soon">Próximamente</span>
                        </div>
                    </div>

                    <div class="tool-card placeholder-card">
                        <div class="tool-card-content">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                            <h3>Centro de Soporte</h3>
                            <p>Accede a tutoriales, guías paso a paso y soporte técnico personalizado para maximizar el uso de todas las herramientas.</p>
                            <span class="coming-soon">Próximamente</span>
                        </div>
                    </div>

                    <div class="tool-card placeholder-card">
                        <div class="tool-card-content">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.708 2.825L15 11.105V5.383zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741zM1 11.105l4.708-2.897L1 5.383v5.722z"/>
                            </svg>
                            <h3>Email Marketing</h3>
                            <p>Herramientas de email marketing automatizado para nutrir leads y convertir prospectos en clientes activos.</p>
                            <span class="coming-soon">Próximamente</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Error state -->
    <div id="error-content" class="error-container" style="display: none;">
        <h2>Error de Autenticación</h2>
        <p>No se pudo cargar el sistema de autenticación. Por favor, recarga la página.</p>
        <button onclick="window.location.reload()" class="btn">Recargar Página</button>
    </div>

    <!-- Cargar Supabase desde CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Script modular con funcionalidad WhatsApp integrada -->
    <script type="module">
        // Importar funciones necesarias - FIX CRÍTICO
        import {
            initializeSupabase,
            authGuard,
            getUserProfile,
            logoutUser,
            getPersonalizedLinks
        } from './assets/js/auth.js';

        import {
            showLoading,
            showMainContent,
            showError,
            formatUserName,
            showMessage,
            clearMessage,
            shareToolWithWhatsApp,
            openTool,
            logout,
            TOOL_CONFIG
        } from './assets/js/utils.js';

        import { MESSAGES } from './assets/js/config.js';

        // Variables globales
        let currentUserProfile = null;
        let isLoading = false;

        console.log('Cargando portal...');

        // Verificar Supabase
        if (typeof supabase === 'undefined') {
            console.error('Supabase no disponible');
            showError(MESSAGES.authRequired);
        } else {
            // Inicializar aplicación
            try {
                initializeSupabase();
                console.log('Supabase inicializado');

                // Función principal
                const loadPortal = async () => {
                    try {
                        console.log('Verificando autenticación...');
                        const session = await authGuard(true);
                        if (!session) return;

                        console.log('Obteniendo perfil...');
                        const profile = await getUserProfile();
                        if (!profile) {
                            showError('Error al cargar perfil');
                            return;
                        }

                        // Guardar perfil globalmente
                        currentUserProfile = profile;

                        console.log('Personalizando portal...');
                        // Actualizar UI
                        const displayName = formatUserName(profile.full_name) || formatUserName(`${profile.first_name || ''} ${profile.last_name || ''}`.trim()) || 'Usuario';
                        document.getElementById('user-name').textContent = displayName;
                        document.getElementById('user-email').textContent = profile.email;

                        // Personalizar mensaje
                        const firstName = displayName.split(' ')[0];
                        document.getElementById('welcome-text').textContent = `Bienvenido, ${firstName}`;

                        console.log('Portal cargado para:', displayName);
                        console.log('Perfil completo:', currentUserProfile);

                        // Configurar event listeners después de cargar el perfil
                        setupEventListeners();

                        showMainContent();

                    } catch (error) {
                        console.error('Error al cargar portal:', error);
                        showError('Error al cargar portal');
                    }
                };

                // FIX CRÍTICO: Event listeners con funcionalidad WhatsApp completa
                const setupEventListeners = () => {
                    // Logout button
                    document.getElementById('logout-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm('¿Cerrar sesión?')) {
                            logout(); // Usa la función corregida de utils.js
                        }
                    });

                    // Event listener para todos los botones de herramientas
                    document.addEventListener('click', async (event) => {
                        const target = event.target;

                        // Prevenir múltiples clics durante loading
                        if (isLoading) return;

                        // Verificar si es un botón de herramienta
                        if (target.dataset.action && target.dataset.tool) {
                            event.preventDefault();

                            const action = target.dataset.action;
                            const toolType = target.dataset.tool;

                            if (!currentUserProfile) {
                                showMessage('Error: Perfil de usuario no disponible', 'error');
                                return;
                            }

                            isLoading = true;
                            const originalText = target.textContent;
                            target.disabled = true;

                            try {
                                if (action === 'share') {
                                    // FIX CRÍTICO: Compartir via WhatsApp
                                    target.textContent = 'Generando enlace...';

                                    const toolConfig = TOOL_CONFIG[toolType];
                                    if (!toolConfig) {
                                        throw new Error('Configuración de herramienta no encontrada');
                                    }

                                    shareToolWithWhatsApp(toolType, currentUserProfile, toolConfig.url);

                                } else if (action === 'open') {
                                    // Abrir herramienta directamente
                                    target.textContent = 'Abriendo...';

                                    const toolUrl = target.dataset.url;
                                    if (!toolUrl) {
                                        throw new Error('URL de herramienta no encontrada');
                                    }

                                    openTool(toolUrl, currentUserProfile);
                                }

                            } catch (error) {
                                console.error(`Error en acción ${action}:`, error);
                                showMessage(`Error al ${action === 'share' ? 'compartir' : 'abrir'} herramienta`, 'error');
                            } finally {
                                setTimeout(() => {
                                    target.textContent = originalText;
                                    target.disabled = false;
                                    isLoading = false;
                                }, 2000);
                            }
                        }
                    });

                    console.log('Event listeners configurados correctamente');
                };

                // Inicializar
                loadPortal();

            } catch (error) {
                console.error('Error de inicialización:', error);
                showError('Error al inicializar');
            }
        }

        // Manejo de errores de red
        window.addEventListener('online', () => {
            showMessage('Conexión restaurada', 'success', 3000);
        });

        window.addEventListener('offline', () => {
            showMessage('Sin conexión a internet', 'error', 5000);
        });

        // Manejar orientación en móvil
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100);
        });
    </script>
</body>
</html>
