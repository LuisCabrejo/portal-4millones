<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Organización 4 Millones</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- CSS modular -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">

    <style>
        /* 🚨 FIX: Prevenir pantalla blanca con estilos de emergencia */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }

        #main-content {
            opacity: 0;
            transition: opacity 0.4s ease;
            min-height: 100vh;
            background: #f8fafc;
        }

        #main-content.show {
            opacity: 1;
        }

        #error-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        /* Estilos para botones de compartir */
        .share-button {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            margin-left: 10px;
        }

        .share-button:hover {
            background: #1a9e52;
            transform: translateY(-1px);
        }

        .share-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .link-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .link-text {
            flex: 1;
            min-width: 200px;
            word-break: break-all;
        }

        .copy-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-button:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <!-- Loading state mejorado -->
    <div id="loading" class="loading-container">
        <div class="loading-spinner large"></div>
        <p>Cargando perfil...</p>
        <small id="loading-status">Inicializando...</small>
    </div>

    <!-- Main content (hidden initially) -->
    <div id="main-content" style="display: none;">
        <div class="particles">
            <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
            <div class="particle" style="left: 20%; animation-delay: 1s;"></div>
            <div class="particle" style="left: 30%; animation-delay: 2s;"></div>
            <div class="particle" style="left: 40%; animation-delay: 3s;"></div>
            <div class="particle" style="left: 50%; animation-delay: 4s;"></div>
            <div class="particle" style="left: 60%; animation-delay: 5s;"></div>
            <div class="particle" style="left: 70%; animation-delay: 6s;"></div>
            <div class="particle" style="left: 80%; animation-delay: 7s;"></div>
            <div class="particle" style="left: 90%; animation-delay: 0.5s;"></div>
        </div>

        <div class="main-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="logo-container">
                        <h2>Proyecto 4 Millones</h2>
                        <p>Centro de Socios Estratégicos</p>
                    </div>
                </div>

                <!-- User info section -->
                <div class="user-info" id="user-info">
                    <div class="user-name" id="user-name">Cargando...</div>
                    <div class="user-email" id="user-email">Cargando...</div>
                    <button class="logout-btn" id="logout-btn">Cerrar Sesión</button>
                </div>

                <nav class="sidebar-nav">
                    <a href="../index.html">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                    <a href="profile.html" class="active">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        <span>Mi Perfil</span>
                    </a>
                </nav>

                <div class="sidebar-footer">
                    &copy; 2025 - 4millones.com
                </div>
            </aside>

            <main class="content-area">
                <div class="profile-container">
                    <!-- Header del perfil -->
                    <div class="profile-header animate-slide-up">
                        <div class="profile-avatar" id="profile-avatar">
                            4M
                        </div>
                        <h1 id="profile-title">Mi Perfil</h1>
                        <p id="profile-subtitle">Gestiona tu información personal y configuraciones</p>
                    </div>

                    <!-- Formulario de perfil -->
                    <div class="profile-form animate-stagger">
                        <h2>Información Personal</h2>

                        <div id="message"></div>

                        <form id="profile-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="full_name">Nombre Completo</label>
                                    <input type="text" id="full_name" name="full_name" required readonly>
                                    <div id="name-validation" class="validation-message"></div>
                                </div>

                                <div class="form-group">
                                    <label for="email">Correo Electrónico</label>
                                    <input type="email" id="email" name="email" required readonly>
                                    <div id="email-validation" class="validation-message"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="whatsapp">Número de WhatsApp</label>
                                    <input type="tel" id="whatsapp" name="whatsapp" placeholder="+57 300 123 4567" autocomplete="tel">
                                    <div class="validation-message">
                                        <small>Este número se usará para que los clientes te contacten directamente</small>
                                    </div>
                                    <div id="whatsapp-validation" class="validation-message"></div>
                                </div>

                                <div class="form-group">
                                    <label for="affiliate_link">Enlace de Afiliación de Gano Excel</label>
                                    <input type="url" id="affiliate_link" name="affiliate_link" placeholder="https://tu-enlace-gano.com" autocomplete="url">
                                    <div class="validation-message">
                                        <small>Tu enlace personalizado de Gano Excel para referencias</small>
                                    </div>
                                    <div id="affiliate-validation" class="validation-message"></div>
                                </div>
                            </div>

                            <button type="submit" class="btn" id="submit-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; margin-right: 8px;">
                                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                                </svg>
                                Guardar Cambios
                            </button>
                        </form>

                        <!-- Enlaces personalizados mejorados -->
                        <div class="mt-5">
                            <h3 style="color: var(--dark-text); margin-bottom: 20px;">Enlaces Personalizados</h3>
                            <div class="card">
                                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                                    Cuando compartas las herramientas del portal, se incluirá automáticamente tu información:
                                </p>

                                <!-- Catálogo -->
                                <div style="background: var(--bg-light); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                                    <strong>Catálogo:</strong>
                                    <div class="link-container">
                                        <span class="link-text" id="catalog-link">https://catalogo.4millones.com/?distribuidor=tu-nombre</span>
                                        <button class="copy-button" onclick="copyToClipboard('catalog-link')" title="Copiar enlace">
                                            📋 Copiar
                                        </button>
                                        <button class="share-button" id="share-catalog-btn" title="Compartir por WhatsApp">
                                            📱 Compartir
                                        </button>
                                    </div>
                                </div>

                                <!-- Modelo de Negocio -->
                                <div style="background: var(--bg-light); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                                    <strong>Modelo de Negocio:</strong>
                                    <div class="link-container">
                                        <span class="link-text" id="business-link">https://oportunidad.4millones.com/?distribuidor=tu-nombre</span>
                                        <button class="copy-button" onclick="copyToClipboard('business-link')" title="Copiar enlace">
                                            📋 Copiar
                                        </button>
                                        <button class="share-button" id="share-business-btn" title="Compartir por WhatsApp">
                                            📱 Compartir
                                        </button>
                                    </div>
                                </div>

                                <!-- 🆕 Enlace de Afiliación -->
                                <div style="background: var(--bg-light); padding: 15px; border-radius: 12px;" id="affiliate-section">
                                    <strong>Enlace de Afiliación:</strong>
                                    <div class="link-container">
                                        <span class="link-text" id="affiliate-display" style="color: #718096;">No configurado</span>
                                        <button class="copy-button" id="copy-affiliate-btn" onclick="copyToClipboard('affiliate-display')" title="Copiar enlace de afiliación" style="display: none;">
                                            📋 Copiar
                                        </button>
                                        <button class="share-button" id="share-affiliate-btn" title="Compartir enlace de afiliación por WhatsApp" style="display: none;">
                                            📱 Compartir
                                        </button>
                                    </div>
                                    <small style="color: #718096; display: block; margin-top: 5px;">
                                        Configura tu enlace de afiliación arriba para poder compartirlo
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Error state mejorado -->
    <div id="error-content" class="error-container" style="display: none;">
        <h2>Error de Autenticación</h2>
        <p id="error-message">No se pudo cargar tu perfil. Por favor, inicia sesión nuevamente.</p>
        <button onclick="window.location.href='../auth/login.html'" class="btn">Ir al Login</button>
        <br><br>
        <button onclick="window.location.reload()" class="btn" style="background: #6c757d;">Recargar Página</button>
    </div>

    <!-- Cargar Supabase desde CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Scripts modulares con manejo robusto de errores -->
    <script type="module">
        // 🚨 FIX: Función para actualizar estado de loading
        const updateLoadingStatus = (message) => {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('📋 Status:', message);
        };

        // 🚨 FIX: Función para mostrar contenido principal sin errores
        const showMainContentSafe = () => {
            try {
                const loading = document.getElementById('loading');
                const mainContent = document.getElementById('main-content');
                const errorContent = document.getElementById('error-content');

                console.log('📋 Elementos encontrados:', {
                    loading: !!loading,
                    mainContent: !!mainContent,
                    errorContent: !!errorContent
                });

                if (loading) {
                    loading.style.display = 'none';
                }

                if (errorContent) {
                    errorContent.style.display = 'none';
                }

                if (mainContent) {
                    mainContent.style.display = 'block';
                    // Triggear animación después de un delay
                    setTimeout(() => {
                        mainContent.classList.add('show');
                    }, 100);
                }

                console.log('✅ Contenido principal mostrado');
            } catch (error) {
                console.error('❌ Error al mostrar contenido:', error);
            }
        };

        // 🚨 FIX: Función para mostrar error sin problemas
        const showErrorSafe = (message = 'Error al cargar el perfil') => {
            try {
                const loading = document.getElementById('loading');
                const mainContent = document.getElementById('main-content');
                const errorContent = document.getElementById('error-content');
                const errorMessage = document.getElementById('error-message');

                if (loading) {
                    loading.style.display = 'none';
                }

                if (mainContent) {
                    mainContent.style.display = 'none';
                }

                if (errorContent) {
                    errorContent.style.display = 'flex';
                }

                if (errorMessage) {
                    errorMessage.textContent = message;
                }

                console.log('🚨 Error mostrado:', message);
            } catch (error) {
                console.error('❌ Error al mostrar error:', error);
            }
        };

        // 📋 Función para copiar al portapapeles
        window.copyToClipboard = async (elementId) => {
            const element = document.getElementById(elementId);
            const text = element.textContent.trim();

            if (!text || text === 'No configurado') {
                alert('⚠️ No hay contenido para copiar');
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                alert('✅ Enlace copiado al portapapeles');
            } catch (err) {
                console.error('Error al copiar:', err);
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ Enlace copiado al portapapeles');
            }
        };

        // Inicialización con manejo robusto de errores
        updateLoadingStatus('Verificando disponibilidad...');

        // 🚨 FIX: Verificar que Supabase esté cargado antes de continuar
        if (typeof supabase === 'undefined') {
            console.error('❌ Supabase no se pudo cargar');
            updateLoadingStatus('Error: Supabase no disponible');
            setTimeout(() => {
                showErrorSafe('Error al cargar el sistema de autenticación. Verifica tu conexión a internet.');
            }, 2000);
        } else {
            updateLoadingStatus('Cargando módulos...');

            try {
                // Importar funciones con manejo de errores
                Promise.all([
                    import('../assets/js/auth.js').catch(err => {
                        console.error('❌ Error al cargar auth.js:', err);
                        throw new Error('No se pudo cargar el módulo de autenticación');
                    }),
                    import('../assets/js/utils.js').catch(err => {
                        console.error('❌ Error al cargar utils.js:', err);
                        throw new Error('No se pudo cargar el módulo de utilidades');
                    }),
                    import('../assets/js/config.js').catch(err => {
                        console.error('❌ Error al cargar config.js:', err);
                        throw new Error('No se pudo cargar el módulo de configuración');
                    })
                ]).then(([authModule, utilsModule, configModule]) => {

                    updateLoadingStatus('Módulos cargados, inicializando...');

                    // Extraer funciones
                    const {
                        initializeSupabase,
                        authGuard,
                        getUserProfile,
                        updateUserProfile,
                        logoutUser
                    } = authModule;

                    const {
                        showMessage,
                        clearMessage,
                        updateButton,
                        validateWhatsApp,
                        validateURL,
                        formatUserName,
                        formatWhatsApp,
                        validateField,
                        getPersonalizedLinks,
                        generateWhatsAppShareUrl
                    } = utilsModule;

                    const { MESSAGES } = configModule;

                    // Variable global para el perfil
                    let currentUserProfile = null;

                    updateLoadingStatus('Inicializando Supabase...');

                    // Inicializar Supabase
                    initializeSupabase();
                    console.log('✅ Supabase inicializado');

                    // 📱 Función para compartir enlace por WhatsApp
                    const shareViaWhatsApp = (linkType, linkUrl) => {
                        if (!linkUrl || linkUrl === 'No configurado') {
                            alert('⚠️ No hay enlace para compartir');
                            return;
                        }

                        let message = '';
                        switch (linkType) {
                            case 'catalog':
                                message = '¡Hola! Te comparto nuestro catálogo completo de productos Gano Excel: ';
                                break;
                            case 'business':
                                message = '¡Hola! Te comparto información sobre la oportunidad de negocio con Gano Excel: ';
                                break;
                            case 'affiliate':
                                message = '¡Hola! Te comparto mi enlace de afiliación de Gano Excel: ';
                                break;
                            default:
                                message = '¡Hola! Te comparto este enlace: ';
                        }

                        const whatsappUrl = generateWhatsAppShareUrl(message, linkUrl);
                        if (whatsappUrl !== '#') {
                            window.open(whatsappUrl, '_blank');
                            showMessage('✅ Abriendo WhatsApp para compartir', 'success');
                        } else {
                            showMessage('❌ Error al generar enlace de WhatsApp', 'error');
                        }
                    };

                    // Referencias a elementos del DOM
                    const profileForm = document.getElementById('profile-form');
                    const submitBtn = document.getElementById('submit-btn');
                    const logoutBtn = document.getElementById('logout-btn');

                    // Campos del formulario
                    const fullNameInput = document.getElementById('full_name');
                    const emailInput = document.getElementById('email');
                    const whatsappInput = document.getElementById('whatsapp');
                    const affiliateLinkInput = document.getElementById('affiliate_link');

                    // Elementos de información del usuario
                    const userNameEl = document.getElementById('user-name');
                    const userEmailEl = document.getElementById('user-email');
                    const profileAvatarEl = document.getElementById('profile-avatar');
                    const profileTitleEl = document.getElementById('profile-title');

                    // Enlaces personalizados
                    const catalogLinkEl = document.getElementById('catalog-link');
                    const businessLinkEl = document.getElementById('business-link');
                    const affiliateDisplayEl = document.getElementById('affiliate-display');
                    const copyAffiliateBtnEl = document.getElementById('copy-affiliate-btn');
                    const shareAffiliateBtnEl = document.getElementById('share-affiliate-btn');

                    // Botones de compartir
                    const shareCatalogBtn = document.getElementById('share-catalog-btn');
                    const shareBusinessBtn = document.getElementById('share-business-btn');

                    // Función para actualizar la visualización del enlace de afiliación
                    const updateAffiliateDisplay = (affiliateLink) => {
                        if (affiliateLink && affiliateLink.trim()) {
                            affiliateDisplayEl.textContent = affiliateLink;
                            affiliateDisplayEl.style.color = '#1a202c';
                            copyAffiliateBtnEl.style.display = 'inline-flex';
                            shareAffiliateBtnEl.style.display = 'inline-flex';

                            // Agregar event listener para compartir
                            shareAffiliateBtnEl.onclick = () => shareViaWhatsApp('affiliate', affiliateLink);
                        } else {
                            affiliateDisplayEl.textContent = 'No configurado';
                            affiliateDisplayEl.style.color = '#718096';
                            copyAffiliateBtnEl.style.display = 'none';
                            shareAffiliateBtnEl.style.display = 'none';
                        }
                    };

                    // Función principal para cargar datos del perfil
                    const loadProfile = async () => {
                        try {
                            updateLoadingStatus('Verificando autenticación...');

                            const session = await authGuard(false);
                            if (!session) {
                                updateLoadingStatus('Redirigiendo al login...');
                                setTimeout(() => {
                                    window.location.href = '../auth/login.html';
                                }, 1000);
                                return;
                            }

                            updateLoadingStatus('Obteniendo perfil...');

                            const profile = await getUserProfile();
                            if (!profile) {
                                throw new Error('No se pudo cargar el perfil del usuario');
                            }

                            currentUserProfile = profile;
                            console.log('📋 Perfil COMPLETO cargado:', profile);

                            updateLoadingStatus('Personalizando interfaz...');

                            // Actualizar información en sidebar
                            const displayName = formatUserName(profile.full_name) || 'Usuario';
                            userNameEl.textContent = displayName;
                            userEmailEl.textContent = profile.email;

                            // Actualizar avatar con iniciales
                            const initials = displayName.split(' ').map(n => n[0]).join('').slice(0, 2);
                            profileAvatarEl.textContent = initials;

                            // Actualizar título del perfil
                            profileTitleEl.textContent = `Perfil de ${displayName}`;

                            // Llenar formulario
                            fullNameInput.value = profile.full_name || '';
                            emailInput.value = profile.email || '';
                            whatsappInput.value = profile.whatsapp || '';
                            affiliateLinkInput.value = profile.affiliate_link || '';

                            // Generar enlaces personalizados
                            console.log('🔗 Generando enlaces personalizados...');
                            const personalizedLinks = getPersonalizedLinks(profile);
                            console.log('✅ Enlaces generados:', personalizedLinks);

                            catalogLinkEl.textContent = personalizedLinks.catalog;
                            businessLinkEl.textContent = personalizedLinks.business;

                            // Actualizar visualización del enlace de afiliación
                            updateAffiliateDisplay(profile.affiliate_link);

                            // Configurar event listeners para compartir herramientas
                            shareCatalogBtn.onclick = () => shareViaWhatsApp('catalog', personalizedLinks.catalog);
                            shareBusinessBtn.onclick = () => shareViaWhatsApp('business', personalizedLinks.business);

                            updateLoadingStatus('Configurando eventos...');

                            // Configurar event listeners
                            setupEventListeners();

                            updateLoadingStatus('¡Listo!');

                            // Mostrar contenido principal
                            setTimeout(() => {
                                showMainContentSafe();
                            }, 500);

                        } catch (error) {
                            console.error('❌ Error al cargar perfil:', error);
                            updateLoadingStatus('Error al cargar perfil');
                            setTimeout(() => {
                                showErrorSafe(error.message || 'Error al cargar el perfil');
                            }, 1000);
                        }
                    };

                    // Configurar event listeners
                    const setupEventListeners = () => {
                        // Validación en tiempo real para WhatsApp
                        if (whatsappInput) {
                            whatsappInput.addEventListener('input', () => {
                                const whatsapp = whatsappInput.value;
                                if (whatsapp.length > 0) {
                                    const isValid = validateWhatsApp(whatsapp);
                                    validateField(
                                        whatsappInput,
                                        'whatsapp-validation',
                                        isValid,
                                        '✓ Número válido',
                                        'Formato inválido (ej: +57 300 123 4567)'
                                    );
                                }
                            });

                            whatsappInput.addEventListener('blur', () => {
                                if (whatsappInput.value.trim()) {
                                    whatsappInput.value = formatWhatsApp(whatsappInput.value);
                                }
                            });
                        }

                        // Validación para enlace de afiliación
                        if (affiliateLinkInput) {
                            affiliateLinkInput.addEventListener('input', () => {
                                const url = affiliateLinkInput.value;
                                if (url.length > 0) {
                                    const isValid = validateURL(url);
                                    validateField(
                                        affiliateLinkInput,
                                        'affiliate-validation',
                                        isValid,
                                        '✓ URL válida',
                                        'URL inválida (ej: https://tu-enlace-gano.com)'
                                    );

                                    // Actualizar preview en tiempo real
                                    if (isValid) {
                                        updateAffiliateDisplay(url);
                                    }
                                } else {
                                    updateAffiliateDisplay('');
                                }
                            });
                        }

                        // Logout
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                                    logoutUser();
                                }
                            });
                        }

                        // Envío del formulario
                        if (profileForm) {
                            profileForm.addEventListener('submit', async (event) => {
                                event.preventDefault();

                                clearMessage();
                                updateButton(submitBtn, true, 'Guardando...');

                                try {
                                    const whatsapp = whatsappInput.value.trim();
                                    const affiliateLink = affiliateLinkInput.value.trim();

                                    // Validar datos
                                    if (whatsapp && !validateWhatsApp(whatsapp)) {
                                        throw new Error('Por favor, ingresa un número de WhatsApp válido');
                                    }

                                    if (affiliateLink && !validateURL(affiliateLink)) {
                                        throw new Error('Por favor, ingresa una URL válida para tu enlace de afiliación');
                                    }

                                    // Actualizar perfil
                                    const updatedProfile = await updateUserProfile({
                                        full_name: fullNameInput.value.trim(),
                                        whatsapp: formatWhatsApp(whatsapp),
                                        affiliate_link: affiliateLink
                                    });

                                    showMessage(MESSAGES.profileUpdated, 'success');

                                    // Actualizar UI
                                    const displayName = formatUserName(fullNameInput.value.trim());
                                    userNameEl.textContent = displayName;
                                    profileTitleEl.textContent = `Perfil de ${displayName}`;

                                    // Actualizar perfil global
                                    if (updatedProfile) {
                                        currentUserProfile = updatedProfile;

                                        // Actualizar enlaces personalizados
                                        const personalizedLinks = getPersonalizedLinks(updatedProfile);
                                        catalogLinkEl.textContent = personalizedLinks.catalog;
                                        businessLinkEl.textContent = personalizedLinks.business;

                                        // Actualizar enlace de afiliación
                                        updateAffiliateDisplay(updatedProfile.affiliate_link);
                                    }

                                } catch (error) {
                                    console.error('Error al actualizar perfil:', error);
                                    showMessage('Error al actualizar el perfil: ' + error.message, 'error');
                                } finally {
                                    updateButton(submitBtn, false, 'Guardar Cambios');
                                }
                            });
                        }

                        console.log('✅ Event listeners configurados');
                    };

                    // Inicializar página
                    loadProfile();

                }).catch(error => {
                    console.error('❌ Error al cargar módulos:', error);
                    updateLoadingStatus('Error al cargar módulos');
                    setTimeout(() => {
                        showErrorSafe('Error al cargar los módulos necesarios. Verifica tu conexión a internet.');
                    }, 2000);
                });

            } catch (error) {
                console.error('❌ Error crítico de inicialización:', error);
                updateLoadingStatus('Error crítico de inicialización');
                setTimeout(() => {
                    showErrorSafe('Error crítico al inicializar la aplicación.');
                }, 2000);
            }
        }
    </script>
</body>
</html>
